{% extends "core/base.html" %}
{% load static %}
{% load room_tags %}

{% block title %}yamsa | {{ current_room.name }}{% endblock %}

{% block content %}
    {# Hey <username >#}
    {% if request.user.is_authenticated %}
        <small>Hey
            <span class="text-primary-emphasis">{{ request.user.name }}</span>!
        </small>
    {% endif %}

    {# Room name and copy room button #}
    <div class="row align-items-center my-3">
        <div class="col-9 col-md-5 text-break">
            <h1 class="mb-0" {% if current_room.is_closed %}style="text-decoration: line-through"{% endif %}>
                {{ current_room.name }}
            </h1>
        </div>
        <div class=" col-3 col-md-7 d-flex justify-content-center">
            {% if current_room.is_open and current_room.has_guests %}
                <button class="btn btn-light btn-sm"
                        onclick="copyShareURL()"
                        data-bs-toggle="tooltip"
                        data-bs-title="Copy the rooms URL to your clipboard to send it to your friends"
                        hx-get="{% url 'htmx-checked-clipboard' %}"
                        hx-swap="morph:innerHTML"
                >
                    {% include "shared_partials/clipboard_icon_unchecked.html" %}
                </button>
            {% elif current_room.is_closed %}
                <h1 class="mb-0">
                    <i class="bi bi-dash-circle"
                       hx-get="{% room_url 'room-edit' %}"
                       hx-target="#body"
                       hx-swap="morph:innerHTML"
                       hx-push-url="true"
                    ></i>
                </h1>
            {% endif %}
        </div>
    </div>

    {# Room description #}
    <div class="mb-3">
        <small>{{ current_room.description }}</small>
    </div>

    {% if request.user.is_authenticated %}
        {# Room Tab-Headers #}
        <ul class="nav nav-tabs nav-fill" id="roomTab" role="tablist">

            {% for tab in dashboard_tabs %}
                <li class="nav-item" role="presentation" style="cursor: pointer">
                    <a id="{{ tab.name }}-tab"
                       class="nav-link {% if active_tab == tab.name %}active{% endif %}"
                       role="tab"
                       data-bs-toggle="tab"
                       data-bs-target="#{{ tab.name }}-tab-content"
                       aria-controls="{{ tab.name }}-tab-content"
                       aria-selected="true"
                       hx-trigger="click"
                       hx-get="{{ tab.get_url }}"
                       hx-target="#body"
                       hx-swap="innerHTML"
                       hx-indicator="#loading-spinner"
                       hx-push-url="true"
                    >
                        <i class="{{ tab.icon_class }}"></i>
                    </a>
                </li>
            {% endfor %}

        </ul>

        {# Room Tab-Contents #}
        <div class="tab-content" id="tab-content">

            {% for tab in dashboard_tabs %}
                <div class="tab-pane fade {% if active_tab == tab.name %}show active{% endif %}"
                     id="{{ tab.name }}-tab-content"
                     role="tabpanel"
                     aria-labelledby="{{ tab.name }}-tab"
                     tabindex="0"
                >
                    {% block tab_content %}
                        {% include "shared_partials/loading_spinner.html" with spinner_id="loading-spinner" %}
                    {% endblock %}

                    <br><br><br><br>
                </div>
            {% endfor %}

        </div>
    {% else %}
        {% include "room/partials/_detail_who_are_you.html" %}
    {% endif %}

    <script type="text/javascript">
      var copyShareURL = () => {
        const url = document.URL
        navigator.clipboard.writeText(url).then(() => {
          // clipboard successfully set
          console.log(`${url} successfully copied to clipboard`)
        }, () => {
          // clipboard write failed
          console.error("Something went wrong here")
        });
      }
    </script>

    <script type="module">
      // TODO CT: Joa keine Ahnung, fix this I guess
      /*
      const triggerTabList = document.querySelectorAll('#roomTab a')

      let currentActiveTab = undefined
      let nextTabToBeActive = undefined

      const getNextIndex = (index, swipeDirection) => {
        if (swipeDirection === "swipeleft") {
          return index + 1 > triggerTabList.length - 1 ? 0 : index + 1
        } else if (swipeDirection === "swiperight") {
          return index - 1 < 0 ? triggerTabList.length - 1 : index - 1
        }
        return index
      }

      $(function () {
        $("#tab-content").on("swipeleft", swipeHandler).on("swiperight", swipeHandler);

        // Callback function references the event target and adds the 'swipe' class to it
        function swipeHandler(event) {
          console.log(event.type)
          console.log("currentActiveTab", currentActiveTab)
          console.log("nextTabToBeActive", nextTabToBeActive)

          triggerTabList.forEach((el, index) => {
            if (el.getAttribute("aria-selected") === "true") {
              currentActiveTab = el

              nextTabToBeActive = triggerTabList[getNextIndex(index, event.type)]

              window.bootstrap.Tab.getOrCreateInstance(nextTabToBeActive).show()
              return false;
            }
          })
        }
      });
       */
    </script>
{% endblock %}
