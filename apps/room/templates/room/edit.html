{% extends "room/dashboard.html" %}
{% load static %}
{% load room_tags %}
{% block tab_content %}
    <section class="container-fluid px-2 px-md-4 px-lg-5 py-4">
        <div class="d-flex flex-column flex-md-row align-items-start justify-content-between gap-3 mb-4">
            <div class="d-flex align-items-center gap-3">
                <i class="bi bi-arrow-left-circle fs-2 cursor-pointer text-primary"
                   role="button"
                   aria-label="Back to room"
                   hx-trigger="click"
                   hx-get="{% room_url 'room:detail' %}"
                   hx-target="#body"
                   hx-indicator="#body-loading-spinner"
                   hx-swap="morph:innerHTML"
                   hx-push-url="true"></i>
                <div>
                    <p class="text-muted small mb-1">Room settings</p>
                    <h3 class="fw-semibold mb-0">Edit “{{ current_room.name }}”</h3>
                </div>
            </div>
            {% if current_room.is_open %}
                <button type="submit"
                        form="room-details-form"
                        class="btn btn-primary btn-sm px-4 py-2 d-inline-flex align-items-center gap-1"
                        aria-label="Save room details">
                    <i class="bi bi-save"></i>
                    Save
                </button>
            {% endif %}
        </div>
        <div class="row g-4">
            <div class="col-12 col-lg-8">
                <div class="card rounded-4 shadow-sm border-0 h-100">
                    <div class="card-body">
                        <div class="d-flex flex-column gap-1 mb-3">
                            <p class="text-muted small mb-0">Basics</p>
                            <h5 class="fw-semibold mb-0">Name, description &amp; currency</h5>
                            {% if form.errors %}<small class="text-danger">Please fix the highlighted errors in the form.</small>{% endif %}
                        </div>
                        <form id="room-details-form"
                              class="row g-3"
                              hx-post="{% room_url 'room:edit' %}"
                              hx-target="#body"
                              hx-indicator="#body-loading-spinner"
                              hx-swap="morph:innerHTML">
                            {% csrf_token %}
                            <div class="col-12">
                                <label for="name" class="form-label fw-semibold">{{ form.fields.name.label }}</label>
                                <input type="text"
                                       class="form-control"
                                       id="name"
                                       name="name"
                                       required
                                       value="{{ current_room.name }}"
                                       {% if current_room.is_closed %}disabled{% endif %}>
                                {% for error_message in form.errors.name.data %}
                                    <small class="text-danger">{{ error_message.message }}</small>
                                {% endfor %}
                            </div>
                            <div class="col-12">
                                <label for="description" class="form-label fw-semibold">{{ form.fields.description.label }}</label>
                                <input type="text"
                                       class="form-control"
                                       id="description"
                                       name="description"
                                       value="{{ current_room.description }}"
                                       placeholder="-"
                                       maxlength="50"
                                       {% if current_room.is_closed %}disabled{% endif %}>
                                {% for error_message in form.errors.description.data %}
                                    <small class="text-danger">{{ error_message.message }}</small>
                                {% endfor %}
                            </div>
                            <div class="col-12">
                                <label for="preferred_currency" class="form-label fw-semibold">{{ form.fields.preferred_currency.label }}</label>
                                <select name="preferred_currency"
                                        class="form-select"
                                        id="preferred_currency"
                                        required
                                        {% if current_room.is_closed %}disabled{% endif %}>
                                    {% for currency in all_currencies %}
                                        <option value="{{ currency.id }}"
                                                {% if currency == current_room.preferred_currency %}selected{% endif %}>
                                            {{ currency }}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% for error_message in form.errors.preferred_currency.data %}
                                    <small class="text-danger">{{ error_message.message }}</small>
                                {% endfor %}
                            </div>
                            <input type="hidden" name="status" value="{{ current_room.status }}">
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-4">
                <div class="card rounded-4 shadow-sm border-0 h-100">
                    <div class="card-body d-flex flex-column justify-content-between h-100">
                        <div class="mb-3">
                            <p class="text-muted small mb-1">Room status</p>
                            <h5 class="fw-semibold mb-2">{{ current_room.get_status_display }}</h5>
                            {% if current_room.is_open %}
                                {% if current_room.can_be_closed %}
                                    <p class="small text-muted mb-0">All debts are settled. You can close the room.</p>
                                {% elif current_room.open_debt_count > 0 %}
                                    <p class="small text-warning mb-0">
                                        {% if current_room.open_debt_count == 1 %}
                                            There is still {{ current_room.open_debt_count }} open debt.
                                        {% else %}
                                            There are still {{ current_room.open_debt_count }} open debts.
                                        {% endif %}
                                    </p>
                                {% endif %}
                            {% else %}
                                <p class="small text-muted mb-0">The room is closed and can be reopened.</p>
                            {% endif %}
                        </div>
                        <form id="status-action-form"
                              class="mt-3"
                              hx-post="{% room_url 'room:edit' %}"
                              hx-target="#body"
                              hx-indicator="#body-loading-spinner"
                              hx-swap="morph:innerHTML">
                            {% csrf_token %}
                            <input type="hidden" name="name" value="{{ current_room.name }}">
                            <input type="hidden"
                                   name="description"
                                   value="{{ current_room.description }}">
                            <input type="hidden"
                                   name="preferred_currency"
                                   value="{{ current_room.preferred_currency.id }}">
                            <input type="hidden" name="status" value="{{ other_status }}">
                            {{ form.force_close }}
                            <div class="d-grid">
                                {% if current_room.is_open %}
                                    {% if current_room.can_be_closed %}
                                        <button type="submit"
                                                class="btn btn-danger btn-sm rounded-3"
                                                {% if form.errors.status.data %}disabled{% endif %}>Close room</button>
                                    {% elif current_room.open_debt_count > 0 %}
                                        <button type="button"
                                                class="btn btn-outline-danger btn-sm rounded-3"
                                                data-bs-toggle="modal"
                                                data-bs-target="#forceCloseModal"
                                                {% if form.errors.status.data %}disabled{% endif %}>Close room</button>
                                    {% endif %}
                                {% elif current_room.is_closed %}
                                    <button type="submit"
                                            class="btn btn-primary btn-sm rounded-3"
                                            {% if form.errors.status.data %}disabled{% endif %}>Reopen room</button>
                                {% endif %}
                            </div>
                            <div class="mt-3 text-center">
                                {% for error_message in form.errors.status.data %}
                                    <small class="text-danger">{{ error_message.message }}</small>
                                {% endfor %}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% if current_room.open_debt_count > 0 %}
            <div class="modal fade"
                 id="forceCloseModal"
                 tabindex="-1"
                 aria-labelledby="forceCloseModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 border-0 shadow">
                        <div class="modal-header border-0">
                            <div>
                                <h5 class="modal-title fw-semibold" id="forceCloseModalLabel">Outstanding debts</h5>
                                <p class="text-muted small mb-0">This room still has outstanding payments.</p>
                            </div>
                            <button type="button"
                                    class="btn-close"
                                    data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p class="mb-2">
                                {% if current_room.open_debt_count == 1 %}
                                    There is still {{ current_room.open_debt_count }} open debt. Closing the room anyway will mark it as settled.
                                {% else %}
                                    There are still {{ current_room.open_debt_count }} open debts. Closing the room anyway will mark them as settled.
                                {% endif %}
                            </p>
                            <p class="text-muted small mb-0">Use this option only if you want to skip manual settlement.</p>
                        </div>
                        <div class="modal-footer border-0">
                            <button type="button"
                                    class="btn btn-outline-secondary"
                                    data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-danger" id="forceCloseConfirm">Close anyway</button>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </section>
    <script>
        (function () {
            var statusForm = document.getElementById("status-action-form");
            var forceCloseFlag = document.getElementById("force-close-flag");
            var confirmButton = document.getElementById("forceCloseConfirm");
            var forceCloseModal = document.getElementById("forceCloseModal");
            var hasConfirmedForceClose = false;

            var cleanupModalState = function () {
                document.body.classList.remove("modal-open");
                document.body.style.removeProperty("overflow");
                document.body.style.removeProperty("padding-right");
                document.querySelectorAll(".modal-backdrop").forEach(function (el) {
                    el.remove();
                });
            };

            if (!statusForm || !forceCloseFlag || !confirmButton || !forceCloseModal) {
                return;
            }

            confirmButton.addEventListener("click", function () {
                hasConfirmedForceClose = true;
                forceCloseFlag.value = "true";
                confirmButton.blur();

                if (window.bootstrap && window.bootstrap.Modal) {
                    var modalInstance = window.bootstrap.Modal.getInstance(forceCloseModal);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                }
            });

            forceCloseModal.addEventListener("hidden.bs.modal", function () {
                cleanupModalState();

                if (hasConfirmedForceClose) {
                    hasConfirmedForceClose = false;

                    if (typeof statusForm.requestSubmit === "function") {
                        statusForm.requestSubmit();
                    } else {
                        statusForm.submit();
                    }

                    return;
                }

                forceCloseFlag.value = "false";
            });
        })();
    </script>
{% endblock tab_content %}
