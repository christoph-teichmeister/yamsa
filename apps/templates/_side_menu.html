{% load room_tags %}

<nav class="navbar fixed-top pt-4" style="background-color: #1e1b1e;">
    <div class="container-fluid pt-4 justify-content-center" id="offcanvasContainer">

        <div class="row w-100 d-flex justify-content-between">

            <div class="col-1 px-0 d-flex align-items-center">
                <button class="navbar-toggler p-0 text-primary-emphasis" style="border: 0" type="button"
                        data-bs-toggle="offcanvas"
                        data-bs-target="#offcanvasNavbar"
                        aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
                    <i class="bi bi-list"></i>
                </button>
            </div>

            {% if current_room %}
                <div class="col-10 p-0 text-center">
                    <h6 class="mb-0">{{ current_room.name }}</h6>
                    <span class="text-muted"
                          style="font-size: 0.7em">{{ current_room.description|truncatechars:50 }}</span>
                </div>

            {% else %}
                <div class="col-11 d-flex align-items-center justify-content-end">
                    <h3 class="mb-0">yamsa</h3>
                </div>

            {% endif %}

            {% if current_room %}
                <div class="col-1 px-0 d-flex align-items-center justify-content-end">
                    {% if current_room.is_open and current_room.has_guests %}
                        <button class="btn btn-light btn-sm"
                                onclick="copyShareURL()"
                                data-bs-toggle="tooltip"
                                data-bs-title="Copy the rooms URL to your clipboard to send it to your friends"
                                hx-get="{% url 'htmx-checked-clipboard' %}"
                                hx-swap="morph:innerHTML"
                        >
                            {% include "shared_partials/clipboard_icon_unchecked.html" %}
                        </button>
                    {% elif current_room.is_closed %}
                        <h1 class="mb-0">
                            <i class="bi bi-dash-circle"
                               hx-get="{% room_url 'room-edit' %}"
                               hx-target="#body"
                               hx-indicator="#body-loading-spinner"
                               hx-swap="morph:innerHTML"
                               hx-push-url="true"
                            ></i>
                        </h1>
                    {% endif %}
                </div>
            {% endif %}

        </div>

        <div class="offcanvas offcanvas-start w-50"
             data-bs-backdrop="true"
             aria-labelledby="offcanvasNavbarLabel"
             tabindex="-1"
             id="offcanvasNavbar"
        >
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Menu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#offcanvasNavbar"
                        aria-label="Close"></button>
            </div>

            <div class="offcanvas-body">

                <div class="row py-3 {% if "/account/detail/" in request.path %} p-e-color{% endif %}">
                    <div class="col text-center cursor-pointer"
                         data-bs-dismiss="offcanvas"
                         data-bs-target="#offcanvasNavbar"
                         hx-trigger="click delay:300ms" {# offcanvas takes 0.3s to close #}
                         hx-get="
                            {% if request.user.is_authenticated %}
                                {% url 'account-user-detail' pk=request.user.id %}
                            {% else %}
                                {% url 'account-user-login' %}
                            {% endif %}"
                         hx-target="#body"
                         hx-indicator="#body-loading-spinner"
                         hx-swap="morph:innerHTML"
                         hx-push-url="true"
                    >
                        <i class="bi bi-person-circle" style="font-size: 3em;"></i>
                        <a class="nav-link">
                            {% if request.user.is_anonymous %}
                                Profile
                            {% else %}
                                {{ request.user.name }}
                            {% endif %}
                        </a>
                    </div>
                </div>

                <div class="row py-1 cursor-pointer d-flex justify-content-center align-items-center{% if request.path == "/welcome/" %} p-e-color{% endif %}">
                    <div class="col-4 text-center fs-1">
                        <i class="bi bi-house"></i>
                    </div>
                    <div class="col-8"
                         data-bs-dismiss="offcanvas"
                         data-bs-target="#offcanvasNavbar"
                         hx-trigger="click delay:300ms" {# offcanvas takes 0.3s to close #}
                         hx-get="{% url 'core-welcome' %}"
                         hx-indicator="#body-loading-spinner"
                         hx-target="#body"
                         hx-swap="morph:innerHTML"
                         hx-push-url="true"
                    >
                        Home
                    </div>
                </div>

                {% include "_side_menu_room_list.html" %}

            </div>
        </div>

    </div>
</nav>

{% if current_room %}
    <script type="text/javascript">
      var copyShareURL = () => {
        const url = document.URL
        navigator.clipboard.writeText(url).then(() => {
          // clipboard successfully set
          console.log(`${url} successfully copied to clipboard`)
        }, () => {
          // clipboard write failed
          console.error("Something went wrong here")
        });
      }
    </script>
{% endif %}

<script type="text/javascript">
  var myOffcanvas = document.getElementById('offcanvasNavbar');

  function removeExcessBackdrops() {
    let fade = document.getElementsByClassName('offcanvas-backdrop fade show')
    for (let i = 0; i < fade.length; i++) {
      while (fade.length > 1) {
        fade[i].remove()
      }
    }
  }

  myOffcanvas.addEventListener('show.bs.offcanvas', event => removeExcessBackdrops());
  myOffcanvas.addEventListener('hide.bs.offcanvas', event => removeExcessBackdrops());

</script>