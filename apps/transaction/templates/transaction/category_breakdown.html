{% extends "room/dashboard.html" %}
{% load static %}
{% load room_tags %}
{% block tab_content %}
    <section class="container px-2 px-md-4 px-lg-5 py-4">
        <style>
            #transaction-category-breakdown-chart {
                min-height: 280px;
            }

            .category-swatch {
                width: 2.25rem;
                height: 2.25rem;
                border-radius: 50%;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                background-color: var(--category-color, #6c757d);
            }
        </style>
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
            <button type="button"
                    class="btn btn-link text-decoration-none ps-0 d-flex align-items-center gap-2"
                    hx-get="{% room_url 'transaction:list' %}#transaction-section"
                    hx-target="#body"
                    hx-indicator="#body-loading-spinner"
                    hx-swap="morph:innerHTML"
                    hx-push-url="true">
                <i class="bi bi-arrow-left"></i>
                Back to transactions
            </button>
            <div class="text-center flex-grow-1">
                <p class="text-uppercase text-muted small mb-1">Category breakdown</p>
                <h2 class="fs-4 fw-semibold mb-1">All recorded spend</h2>
                <p class="text-muted small mb-0">Showing {{ category_breakdown_period }}.</p>
            </div>
            <button type="button"
                    class="btn btn-outline-primary d-flex align-items-center gap-2"
                    hx-get="{% room_url 'transaction:create' %}"
                    hx-target="#body"
                    hx-indicator="#body-loading-spinner"
                    hx-swap="morph:innerHTML"
                    hx-push-url="true">
                <i class="bi bi-plus-lg"></i>
                Add transaction
            </button>
        </div>
        <div class="card border-0 rounded-4 shadow-sm">
            <div class="card-body">
                <div class="row g-4">
                    <div class="col-12 col-lg-7">
                        <div id="transaction-category-breakdown-chart"
                             class="d-flex align-items-center justify-content-center"></div>
                        {{ category_breakdown_chart|json_script:"transaction-category-breakdown-data" }}
                    </div>
                    <div class="col-12 col-lg-5">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <p class="fw-semibold mb-0">Legend</p>
                            <span class="text-muted small">{{ category_breakdown|length }} categories</span>
                        </div>
                        <div class="list-group list-group-flush">
                            {% for category in category_breakdown %}
                                <div class="list-group-item border-0 px-0 py-2 d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center gap-3">
                                        <span class="d-inline-flex align-items-center justify-content-center rounded-circle text-white category-swatch"
                                              style="--category-color: {{ category.color|default:'#6c757d' }}">{{ category.emoji }}</span>
                                        <div>
                                            <p class="mb-0 fw-semibold">{{ category.name }}</p>
                                            <p class="text-muted small mb-0">{{ category.slug|title }}</p>
                                        </div>
                                    </div>
                                    <span class="fw-semibold">{{ category.total_amount|floatformat:2 }}{{ category_breakdown_currency }}</span>
                                </div>
                            {% empty %}
                                <div class="text-center text-muted small">No tracked expenses yet. Add a transaction to populate the breakdown.</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <script>
        (function () {
            const container = document.getElementById("transaction-category-breakdown-chart");
            const dataNode = document.getElementById("transaction-category-breakdown-data");
            if (!container || !dataNode) {
                return;
            }
            const dataset = JSON.parse(dataNode.textContent || "[]") || [];
            const renderChart = () => {
                if (!window.d3) {
                    return;
                }
                container.innerHTML = "";
                if (!dataset.length) {
                    container.innerHTML = "<p class='text-muted small mb-0'>Add expenses to unlock the breakdown.</p>";
                    return;
                }
                const width = container.clientWidth || container.parentElement?.clientWidth || 360;
                const height = Math.max(260, Math.min(360, width));
                const radius = Math.min(width, height) / 2;
                const svg = d3
                    .select(container)
                    .append("svg")
                    .attr("viewBox", `0 0 ${width} ${height}`)
                    .attr("preserveAspectRatio", "xMidYMid meet");
                const chartGroup = svg.append("g").attr("transform", `translate(${width / 2}, ${height / 2})`);
                const pie = d3.pie().value(d => d.value).sort(null);
                const arc = d3.arc().innerRadius(radius * 0.55).outerRadius(radius * 0.95);
                chartGroup
                    .selectAll("path")
                    .data(pie(dataset))
                    .join("path")
                    .attr("d", arc)
                    .attr("fill", d => d.data.color)
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 2)
                    .append("title")
                    .text(d => `${d.data.label}: ${d.data.value.toFixed(2)}`);
            };
            const ensureD3 = () => {
                if (window.d3) {
                    renderChart();
                    return;
                }
                const existing = document.getElementById("d3-lib");
                if (existing) {
                    existing.addEventListener("load", renderChart, { once: true });
                    return;
                }
                const script = document.createElement("script");
                script.id = "d3-lib";
                script.src = "https://cdn.jsdelivr.net/npm/d3@7";
                script.onload = renderChart;
                document.head.appendChild(script);
            };
            ensureD3();
        })();
    </script>
{% endblock tab_content %}
