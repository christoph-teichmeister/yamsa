{% extends "room/dashboard.html" %}
{% load static room_tags i18n %}
{% block tab_content %}
    <style>
        .debt-card {
            border: none;
            border-radius: 1rem;
        }

        .debt-row {
            border-radius: 0.75rem;
            border: 1px solid rgba(var(--bs-body-color-rgb, 33, 37, 41), 0.08);
            padding: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .debt-row + .debt-row {
            margin-top: 0.75rem;
        }

        .debt-row:hover {
            border-color: rgba(var(--bs-primary-rgb, 13, 110, 253), 0.35);
            box-shadow: 0 0 0 3px rgba(var(--bs-primary-rgb, 13, 110, 253), 0.08);
        }

        .action-card {
            border: 1px dashed rgba(var(--bs-primary-rgb, 13, 110, 253), 0.45);
            border-radius: 0.9rem;
            padding: 1rem;
            cursor: pointer;
        }

        .action-card:hover {
            background-color: rgba(var(--bs-primary-rgb, 13, 110, 253), 0.04);
        }
    </style>
    <div class="container-fluid px-0 px-md-2 mt-3">
        <div class="d-flex flex-wrap align-items-start justify-content-between gap-2">
            <div>
                <h4 class="mb-1">{% trans "Optimised debts" %}</h4>
                <p class="text-muted small mb-0">
                    {% trans "Track what is left to settle inside this room. Click the piggy-bank to mark a debt as paid." %}
                </p>
            </div>
            {% if debts %}
                <span class="badge text-bg-light align-self-center">
                    {% blocktrans count active_debt_count=active_debt_count %}
                        {{ active_debt_count }} pending
                    {% endblocktrans %}
                </span>
            {% endif %}
        </div>
        {% if has_transactions %}
            <div class="action-card mt-4 d-flex align-items-center justify-content-between"
                 role="button"
                 tabindex="0"
                 hx-trigger="click keyup[key=='Enter']"
                 hx-get="{% room_url 'debt:money-spent-on-room' %}"
                 hx-target="#body"
                 hx-indicator="#body-loading-spinner"
                 hx-swap="morph:innerHTML"
                 hx-push-url="true">
                <div>
                    <p class="mb-1 fw-semibold">{% trans "Money overview" %}</p>
                    <p class="text-muted small mb-0">{% trans "See how much each person has paid and who still owes what." %}</p>
                </div>
                <i class="bi bi-arrow-up-right-circle fs-4 text-primary"></i>
            </div>
        {% endif %}
        {% if debts %}
            <div class="card debt-card shadow-sm mt-4">
                <div class="card-body">
                    {% for debt in debts %}
                        <div class="debt-row">
                            <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
                                <div>
                                    <p class="fw-semibold mb-1">
                                        {% autoescape off %}
                                            {% parse_user_text debt.debitor.name True %}
                                        {% endautoescape %}
                                        {% if request.user.name == debt.debitor.name %}
                                            {% trans "owe" %}
                                        {% else %}
                                            {% trans "owes" %}
                                        {% endif %}
                                        {{ debt.value }}{{ debt.currency.sign }} to
                                        {% autoescape off %}
                                            {% parse_user_text debt.creditor.name True %}
                                        {% endautoescape %}
                                    </p>
                                    {% if debt.settled %}
                                        <p class="text-success small mb-0">
                                            {% blocktrans with settled_at=debt.settled_at|date:"d.m.Y" %}
                                                Settled on {{ settled_at }}
                                            {% endblocktrans %}
                                        </p>
                                    {% else %}
                                        <p class="text-muted small mb-0">{% trans "Tap the piggy-bank when this debt is paid off." %}</p>
                                    {% endif %}
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    {% if debt.settled %}
                                        <span class="badge text-bg-success-subtle text-success">{% trans "Settled" %}</span>
                                    {% else %}
                                        <span class="badge text-bg-warning-subtle text-warning">{% trans "Outstanding" %}</span>
                                    {% endif %}
                                    <div>{% include "debt/partials/_settle_debt_piggy_icon.html" with debt=debt %}</div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <div class="card debt-card shadow-sm mt-4">
                <div class="card-body text-center py-5">
                    <p class="fw-semibold mb-1">{% trans "No debts yet" %}</p>
                    <p class="text-muted small mb-0">{% trans "As expenses are added, we will surface who owes whom here." %}</p>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock tab_content %}
